//-----------------------------------------------------------------------------
//     Author : hiyohiyo
//       Mail : hiyohiyo@crystalmark.info
//        Web : http://openlibsys.org/
//    License : The modified BSD license
//
//                     Copyright 2007-2008 OpenLibSys.org. All rights reserved.
//-----------------------------------------------------------------------------

#include "OlsApi.h"
#include "OlsIoctl.h"

DWORD WINAPI ReadPhysicalMemory(HANDLE gHandle, DWORD_PTR address, PBYTE buffer, DWORD count, DWORD unitSize)
{
	if (gHandle == INVALID_HANDLE_VALUE)
	{
		return 0;
	}

	if (buffer == NULL)
	{
		return 0;
	}

	DWORD	returnedLength = 0;
	BOOL	result = FALSE;
	DWORD	size = 0;
	OLS_READ_MEMORY_INPUT inBuf;

	if (sizeof(DWORD_PTR) == 4)
	{
		inBuf.Address.HighPart = 0;
		inBuf.Address.LowPart = (DWORD)address;
	}
	else
	{
		inBuf.Address.QuadPart = address;
	}

	inBuf.UnitSize = unitSize;
	inBuf.Count = count;
	size = inBuf.UnitSize * inBuf.Count;

	result = DeviceIoControl(
		gHandle,
		IOCTL_OLS_READ_MEMORY,
		&inBuf,
		sizeof(OLS_READ_MEMORY_INPUT),
		buffer,
		size,
		&returnedLength,
		NULL
	);

	// TEMP
	printf("\nresult=%d (0x%x) getlasterror=%d (0x%x) ... 0x%p", result, result, GetLastError(), GetLastError(), IOCTL_OLS_READ_MEMORY);
	// TEMP

	if (result && returnedLength == size)
	{
		return count * unitSize;
	}
	else
	{
		return 0;
	}
}

DWORD WINAPI WritePhysicalMemory(HANDLE gHandle, DWORD_PTR address, PBYTE buffer, DWORD count, DWORD unitSize)
{
	if (gHandle == INVALID_HANDLE_VALUE)
	{
		return 0;
	}

	if (buffer == NULL)
	{
		return 0;
	}

	DWORD	returnedLength = 0;
	BOOL	result = FALSE;
	DWORD	size = 0;
	DWORD	rCode = 0;
	OLS_WRITE_MEMORY_INPUT* inBuf;

	size = offsetof(OLS_WRITE_MEMORY_INPUT, Data) + count * unitSize;
	inBuf = (OLS_WRITE_MEMORY_INPUT*)malloc(size);
	if (sizeof(DWORD_PTR) == 4)
	{
		inBuf->Address.HighPart = 0;
		inBuf->Address.LowPart = (DWORD)address;
	}
	else
	{
		inBuf->Address.QuadPart = address;
	}
	inBuf->UnitSize = unitSize;
	inBuf->Count = count;
	memcpy(&inBuf->Data, buffer, count * unitSize);

	result = DeviceIoControl(
		gHandle,
		IOCTL_OLS_WRITE_MEMORY,
		inBuf,
		size,
		NULL,
		0,
		&returnedLength,
		NULL
	);
	if (result)
	{
		rCode = count * unitSize;
	}
	else
	{
		rCode = 0;
	}

	free(inBuf);

	return rCode;
}